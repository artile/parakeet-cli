#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
SOCK="$ROOT_DIR/tmp/parakeet.sock"
PIDFILE="$ROOT_DIR/tmp/parakeetd.pid"
LOGFILE="$ROOT_DIR/output/parakeetd.log"
PY="$ROOT_DIR/.venv/bin/python"
BACKEND="$ROOT_DIR/python/parakeet_backend.py"

mkdir -p "$ROOT_DIR/tmp" "$ROOT_DIR/output"
export PARAKEET_HOME="$ROOT_DIR"
export HF_HOME="$ROOT_DIR/.cache/hf"
export TRANSFORMERS_CACHE="$ROOT_DIR/.cache/hf"
export TORCH_HOME="$ROOT_DIR/.cache/torch"
export NEMO_HOME="$ROOT_DIR/.cache/nemo"
export PIP_CACHE_DIR="$ROOT_DIR/.cache/pip"

cmd="${1:-status}"

is_running() {
  if [[ -f "$PIDFILE" ]]; then
    pid="$(cat "$PIDFILE" 2>/dev/null || true)"
    [[ -n "$pid" ]] && kill -0 "$pid" 2>/dev/null
  else
    return 1
  fi
}

case "$cmd" in
  start)
    if is_running; then
      echo "parakeetd already running (pid $(cat "$PIDFILE"))"
      exit 0
    fi
    rm -f "$SOCK"
    nohup "$PY" "$BACKEND" --serve --socket-path "$SOCK" >"$LOGFILE" 2>&1 &
    echo $! > "$PIDFILE"
    for _ in $(seq 1 240); do
      if [[ -S "$SOCK" ]]; then
        break
      fi
      if ! is_running; then
        break
      fi
      sleep 1
    done
    if is_running && [[ -S "$SOCK" ]]; then
      echo "parakeetd started (pid $(cat "$PIDFILE"))"
      echo "socket: $SOCK"
      echo "log: $LOGFILE"
    else
      echo "failed to start parakeetd; check $LOGFILE" >&2
      exit 1
    fi
    ;;
  stop)
    if is_running; then
      kill "$(cat "$PIDFILE")" || true
      rm -f "$PIDFILE" "$SOCK"
      echo "parakeetd stopped"
    else
      rm -f "$PIDFILE" "$SOCK"
      echo "parakeetd not running"
    fi
    ;;
  restart)
    "$0" stop
    "$0" start
    ;;
  status)
    if is_running; then
      echo "parakeetd running (pid $(cat "$PIDFILE"))"
      echo "socket: $SOCK"
      echo "log: $LOGFILE"
    else
      echo "parakeetd not running"
      exit 1
    fi
    ;;
  logs)
    tail -n 80 "$LOGFILE"
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|status|logs}" >&2
    exit 1
    ;;
esac
